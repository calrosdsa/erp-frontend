# Story 1.2: Task Detail Modal and CRUD Operations

## Status
Ready for Review

## Story
**As a** developer,
**I want** to view, create, and edit task details through a modal interface similar to the existing deal management system,
**so that** I can manage task information efficiently with familiar interface patterns and comprehensive CRUD operations.

## Acceptance Criteria
1. Task detail modal loads and displays comprehensive task information with proper data organization
2. Task modal provides full CRUD operations (create, read, update) with form validation
3. Task detail tabs display relevant information (info, participants, activities) following deal modal structure
4. Task creation and editing forms function correctly with proper error handling and validation
5. Task modal follows existing modal patterns and UI consistency
6. API integration uses existing `/task` endpoints with proper type safety and error handling

## Tasks / Subtasks
- [x] Create `home.task.$id/route.tsx` with task detail loading and CRUD actions (AC: 1, 4, 6)
  - [x] Implement loader with parallel API calls to task detail, stages
  - [x] Add task CRUD action handlers (create, edit) using `/task` endpoints
  - [x] Include proper error handling and session management
  - [x] Set up revalidation strategy following deal route patterns
- [x] Create task schema and data mapping utilities (AC: 2, 4)
  - [x] Create `task-schema.tsx` in util/data/schemas with Zod validation
  - [x] Implement task data transformation functions for API integration
  - [x] Add proper TypeScript typing for task forms and API requests
- [x] Implement task modal component (AC: 1, 5)
  - [x] Create `task-modal.tsx` following `deal-modal.tsx` patterns
  - [x] Include modal navigation and close handling
  - [x] Add responsive design and proper sizing
- [x] Create task form component (AC: 2, 4)
  - [x] Create `task-form.tsx` with React Hook Form and Zod validation
  - [x] Include all task fields with proper input components
  - [x] Add form submission handling and error display
- [x] Implement task detail tabs (AC: 3)
  - [x] Create `tab/task-info.tsx` for main task information display and editing
  - [x] Create observers component for task participants management
  - [x] Add activity tracking tab following deal patterns
- [x] Set up task store and view model (AC: 1, 2)
  - [x] Create `task-store.tsx` using Zustand for modal state management
  - [x] Create `task-viewmodel.tsx` for data processing and business logic
  - [x] Include proper state management for create/edit modes

## Dev Notes

### Previous Story Insights
Story 1.1 completed the task kanban board implementation and established:
- Task API integration patterns with TASK entity (Entity.TASK = 69)
- Task card components and styling conventions
- Task data loading and transition handling patterns
- Proper route structure and component organization

### Data Models
**Task API Endpoints and Types** [Source: app/sdk/index.d.ts#/task]
- `GET /task/detail/{id}` - Retrieve comprehensive task details with participants and activities
- `POST /task` - Create new task record with full task data structure
- `PUT /task` - Update existing task record with validation
- Generated TypeScript types available from `~/sdk/components["schemas"]`
- Task data structure includes: id, name, description, stage, assigned_user, due_date, priority, status

**Stage and Participant Management** [Source: app/routes/home.deal.$id/route.tsx#loader]
- Use existing stage API with Entity.TASK for task-specific stages
- Participant/observer management through existing participant endpoints
- Activity tracking using existing activity logging system

### API Specifications
**Task Detail Loading Pattern** [Source: docs/architecture/api-integration.md#deal-route-pattern]
```typescript
const [stagesRes, taskRes] = await Promise.all([
  client.GET("/stage", {
    params: {
      query: {
        size: MAX_SIZE,
        entity_id: Entity.TASK.toString(),
        column: "index",
        orientation: "ASC",
      },
    },
  }),
  client.GET("/task/detail/{id}", {
    params: {
      path: {
        id: params.id || "",
      },
    },
  }),
]);
```

**Task CRUD Action Pattern** [Source: docs/architecture/api-integration.md#action-handler]
```typescript
switch (data.action) {
  case "edit": {
    const res = await client.PUT("/task", {
      body: mapToTaskData(data.taskData),
    });
    error = res.error?.detail;
    message = res.data?.message;
    shouldRevalidate = true;
    break;
  }
  case "create": {
    const res = await client.POST("/task", {
      body: mapToTaskData(data.taskData),
    });
    error = res.error?.detail;
    message = res.data?.message;
    task = res.data?.result;
    shouldRevalidate = true;
    break;
  }
}
```

### Component Specifications
**Modal Component Structure** [Source: app/routes/home.deal.$id/deal-modal.tsx]
- Create `task-modal.tsx` component following existing modal patterns
- Include proper modal sizing, navigation, and close handling
- Use shadcn/ui Modal components with consistent styling
- Support both create (DEFAULT_ID) and edit modes

**Form Component Structure** [Source: app/routes/home.deal.$id/deal-form.tsx]
- Create `task-form.tsx` with React Hook Form integration
- Include Zod schema validation for all task fields
- Use existing form input components and patterns
- Handle form submission with proper error display

**Tab Structure** [Source: app/routes/home.deal.$id/tab/]
- Create `tab/task-info.tsx` for main task information
- Include participant management following observer patterns
- Add activity tab for task history and updates
- Use existing tab layout and navigation patterns

### File Locations
**Route Files** [Source: docs/architecture/project-structure.md#routes]
- `app/routes/home.task.$id/route.tsx` - Task detail route with loader/action
- `app/routes/home.task.$id/task-modal.tsx` - Task modal component
- `app/routes/home.task.$id/task-form.tsx` - Task form component
- `app/routes/home.task.$id/task-store.tsx` - Zustand state management
- `app/routes/home.task.$id/task-viewmodel.tsx` - Business logic layer
- `app/routes/home.task.$id/tab/task-info.tsx` - Task information tab
- `app/routes/home.task.$id/components/observers.tsx` - Participant management

**Schema Files** [Source: docs/architecture/project-structure.md#utilities]
- `app/util/data/schemas/task-schema.tsx` - Task Zod schema and validation
- Follow existing schema patterns from `app/util/data/schemas/crm/deal-schema.tsx`

### Technical Constraints
**TypeScript Configuration** [Source: docs/architecture/tech-stack.md#typescript]
- Use strict TypeScript with generated API types from OpenAPI spec
- Follow existing type import patterns: `components["schemas"]["TaskDto"]`
- Use proper typing for form data and API requests

**Form Validation** [Source: docs/architecture/tech-stack.md#form-handling]
- Use React Hook Form with Zod schema validation
- Follow existing validation patterns from deal forms
- Include proper error handling and display

**State Management** [Source: docs/architecture/tech-stack.md#state-management]
- Use Zustand for modal state management
- Follow existing store patterns from deal modal
- Include proper state initialization and cleanup

**Styling Standards** [Source: docs/architecture/component-standards.md#css]
- Use Tailwind CSS with `cn()` utility for conditional classes
- Follow existing modal and form styling patterns
- Use shadcn/ui components consistently

### Testing
**Note:** Testing requirements ignored per user instruction.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514) - Dev Agent James

### Debug Log References  
*To be filled by dev agent*

### Completion Notes List
- Successfully implemented task detail modal with full CRUD operations
- Created comprehensive task schema with Zod validation matching API structure
- Implemented task form with all required fields: title, status, priority, stage, assignee, project, due date, description
- Created modal layout following existing deal modal patterns with tab navigation
- Set up Zustand store for task state management
- Implemented proper TypeScript typing throughout
- Added activity feed integration for task history tracking
- Fixed form validation and error handling
- Note: Some API limitations found - TaskDto lacks stage_id and index properties, observers/participants not yet supported

### File List
- `app/routes/home.task.$id/route.tsx` - Main task route with loader and actions
- `app/routes/home.task.$id/task-modal.tsx` - Task modal component
- `app/routes/home.task.$id/task-form.tsx` - Task form with all fields
- `app/routes/home.task.$id/task-store.tsx` - Zustand state management
- `app/routes/home.task.$id/task-viewmodel.tsx` - Business logic layer
- `app/routes/home.task.$id/tab/task-info.tsx` - Task information tab
- `app/routes/home.task.$id/components/observers.tsx` - Task observers component
- `app/util/data/schemas/task-schema.tsx` - Task Zod schema and validation

## QA Results
*Results from QA Agent review will be added here*